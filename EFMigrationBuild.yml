- task: PowerShell@2
  displayName: Build EF Core Migration Bundle
  inputs:
    targetType: inline
    script: |
      dotnet tool install --global dotnet-ef --version 9.0.4
      $env:PATH += ";$env:USERPROFILE\.dotnet\tools"

      # 1) Locate the Migrations project (where the Migrations folder lives)
      Write-Host "üîç Finding migrations .csproj..."
      $migrationsProj = Get-ChildItem -Path "$(Build.SourcesDirectory)" -Recurse -Filter *.csproj |
                        Where-Object { Test-Path (Join-Path $_.Directory.FullName "Migrations") } |
                        Select-Object -First 1
      if (-not $migrationsProj) {
        Write-Error "‚ùå Could not find a project containing a Migrations folder"
        exit 1
      }
      Write-Host "‚úÖ Migrations project: $($migrationsProj.FullName)"

      # 2) Locate the WebAPI (startup) project by looking for Program.cs
      Write-Host "üîç Finding startup (WebAPI) .csproj..."
      $startupProj = Get-ChildItem -Path "$(Build.SourcesDirectory)" -Recurse -Filter *.csproj |
                     Where-Object { Test-Path (Join-Path $_.Directory.FullName "Program.cs") } |
                     Select-Object -First 1
      if (-not $startupProj) {
        Write-Error "‚ùå Could not find a startup project containing Program.cs"
        exit 1
      }
      Write-Host "‚úÖ Startup project: $($startupProj.FullName)"

      # 3) Prepare bundle folder
      $bundleDir = "$(Build.ArtifactStagingDirectory)\EFBundle"
      New-Item -ItemType Directory -Path $bundleDir -Force | Out-Null

      # 4) Move into the startup project folder and bundle migrations
      Push-Location $startupProj.Directory.FullName

      Write-Host "üîß Bundling EF migrations..."
      dotnet ef migrations bundle `
        --project "$($migrationsProj.FullName)" `
        --startup-project "$($startupProj.FullName)" `
        --configuration Release `
        --framework net8.0 `
        --runtime win-x64 `
        --self-contained `
        --output "$bundleDir\bundle.exe"

      Pop-Location

      # 5) Verify
      if (Test-Path "$bundleDir\bundle.exe") {
        Write-Host "‚úÖ bundle.exe created at $bundleDir\bundle.exe"
      } else {
        Write-Error "‚ùå bundle.exe not found in $bundleDir"
        exit 1
      }
  workingDirectory: '$(Build.SourcesDirectory)'
