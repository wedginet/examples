- task: PowerShell@2
  displayName: Build Windows Migration Bundle
  inputs:
    targetType: inline
    pwsh: true                # Use PowerShell Core (cross-platform)
    script: |
      # Install the EF tool
      dotnet tool install --global dotnet-ef
      $env:PATH += "$HOME/.dotnet/tools"

      # Emit a *Windows* bundle.exe
      dotnet ef migrations bundle `
        --configuration Release `
        --runtime win-x64 `
        --self-contained true `
        --output "$(Build.ArtifactStagingDirectory)/EFBundle/bundle.exe"

      # Verify it exists
      if (!(Test-Path "$(Build.ArtifactStagingDirectory)/EFBundle/bundle.exe")) {
        Write-Error "❌ bundle.exe not found!"
        exit 1
      }





- task: CopyFiles@2
  displayName: Copy EF bundle and appsettings
  inputs:
    SourceFolder: '$(Build.ArtifactStagingDirectory)'  
    Contents: |
      EFBundle/bundle.exe
      appsettings.json
    TargetFolder: '$(Build.ArtifactStagingDirectory)/EFBundle'



release::::
$efBundleDir = "$(System.DefaultWorkingDirectory)/_AHS Mobile Sync Web API/drop/EFBundle"
$bundlePath  = "$efBundleDir\bundle.exe"

Write-Host "Running migration bundle: $bundlePath"
$connection = $env:DDLConnection
$arguments = @("--connection", "`"$connection`"")

Start-Process -FilePath $bundlePath `
    -ArgumentList $arguments `
    -WorkingDirectory $efBundleDir `
    -NoNewWindow -Wait

if ($LASTEXITCODE -ne 0) {
    Write-Error "Migration bundle failed (exit code $LASTEXITCODE)"
    exit $LASTEXITCODE
}
Write-Host "✅ Migration bundle executed successfully"
