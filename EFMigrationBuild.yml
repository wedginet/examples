- task: PowerShell@2
  displayName: Build EF Core Migration Bundle
  inputs:
    targetType: inline
    script: |
      # 1. Install / update EF CLI
      dotnet tool install --global dotnet-ef --version 9.0.3
      $env:PATH += ";$env:USERPROFILE\.dotnet\tools"

      # 2. Locate your .csproj dynamically
      Write-Host "üîç Searching for first *.csproj under $(Build.SourcesDirectory)..."
      $csproj = Get-ChildItem -Path "$(Build.SourcesDirectory)" -Recurse -Filter *.csproj `
                | Where-Object { $_.Name -notmatch 'Test|Sample' } `
                | Select-Object -First 1
      if (-not $csproj) {
        Write-Error "‚ùå No .csproj found in $(Build.SourcesDirectory)"
        exit 1
      }
      $projectPath = $csproj.FullName
      Write-Host "‚úÖ Found project: $projectPath"

      # 3. Expose it as a pipeline variable (optional)
      Write-Host "##vso[task.setvariable variable=EFProjectPath]$projectPath"

      # 4. Prepare output folder
      $bundleDir = "$(Build.ArtifactStagingDirectory)\EFBundle"
      New-Item -ItemType Directory -Path $bundleDir -Force | Out-Null

      # 5. Build the self-contained Windows bundle
      dotnet ef migrations bundle `
        --project "$projectPath" `
        --startup-project "$projectPath" `
        --configuration Release `
        --runtime win-x64 `
        --self-contained true `
        --output "$bundleDir\bundle.exe"

      # 6. Verify success
      if (Test-Path "$bundleDir\bundle.exe") {
        Write-Host "‚úÖ bundle.exe created at $bundleDir\bundle.exe"
      } else {
        Write-Error "‚ùå bundle.exe not found in $bundleDir"
        exit 1
      }
  workingDirectory: '$(Build.SourcesDirectory)'
