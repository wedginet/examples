# Set correct bundle path
bundlePath="$(System.DefaultWorkingDirectory)/_AHS Mobile Sync Web API/drop/EFBundle/bundle"
bundleDir="$(dirname "$bundlePath")"

echo "ğŸ“‚ Checking for bundle in: $bundlePath"
echo "ğŸ“ Switching to working directory: $bundleDir"

# Ensure directory exists before cd
if [ ! -d "$bundleDir" ]; then
  echo "âŒ Working directory $bundleDir does not exist"
  exit 1
fi

cd "$bundleDir"

# Check that the bundle exists
if [ ! -f "./bundle" ]; then
  echo "âŒ EF bundle not found at ./bundle"
  exit 1
fi

chmod +x ./bundle

# Make sure DDLConnection is set
if [ -z "$DDLConnection" ]; then
  echo "âŒ DDLConnection is not set"
  exit 1
fi

echo "ğŸš€ Running EF migration bundle with connection string"
./bundle --connection "$DDLConnection"
result=$?

if [ $result -ne 0 ]; then
  echo "âŒ EF migration bundle failed with exit code $result"
  exit $result
else
  echo "âœ… EF migration applied successfully"
fi
